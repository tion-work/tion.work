<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI å¼€å‘åŠ©æ‰‹ - Tion</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .chat-container {
      width: 100vw;
      height: 100vh;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .chat-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .chat-header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .project-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .project-selector label {
      font-size: 14px;
      opacity: 0.9;
    }

    .project-selector select {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      min-width: 120px;
    }

    .project-selector select option {
      background: #667eea;
      color: white;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8fafc;
    }

    .message {
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.assistant .message-avatar {
      background: #e2e8f0;
      color: #64748b;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.assistant .message-content {
      background: white;
      border: 1px solid #e2e8f0;
      color: #1e293b;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 4px;
    }

    .message.user .message-time {
      text-align: right;
    }

    .streaming-message {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin: 10px 0;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .streaming-message .log-line {
      margin: 2px 0;
      padding: 2px 0;
    }

    .streaming-message .log-info {
      color: #059669;
    }

    .streaming-message .log-error {
      color: #dc2626;
    }

    .streaming-message .log-warning {
      color: #d97706;
    }

    .chat-input-container {
      padding: 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 24px;
      font-size: 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #667eea;
    }

    .chat-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .sidebar {
      width: 300px;
      background: #f8fafc;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      background: white;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .project-info {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
    }

    .project-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .project-info p {
      font-size: 12px;
      color: #64748b;
      margin: 4px 0;
    }

    .project-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-active {
      background: #dcfce7;
      color: #166534;
    }

    .status-inactive {
      background: #fef3c7;
      color: #92400e;
    }

    .quick-actions {
      background: white;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }

    .quick-actions h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 12px;
    }

    .quick-action-btn {
      width: 100%;
      padding: 8px 12px;
      margin: 4px 0;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      color: #64748b;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .quick-action-btn:hover {
      background: #f1f5f9;
      border-color: #667eea;
      color: #667eea;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 14px;
    }

    .success-message {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: 200px;
        border-left: none;
        border-top: 1px solid #e2e8f0;
      }

      .chat-header {
        flex-direction: column;
        gap: 10px;
      }

      .header-left,
      .header-right {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-left">
        <div>
          <h1>ğŸ¤– AI å¼€å‘åŠ©æ‰‹</h1>
          <p>æ™ºèƒ½ä»£ç ç”Ÿæˆä¸é¡¹ç›®ç®¡ç†å¹³å°</p>
        </div>
      </div>
      <div class="header-right">
        <div class="project-selector">
          <label for="projectSelect">é¡¹ç›®:</label>
          <select id="projectSelect">
            <option value="">é€‰æ‹©é¡¹ç›®...</option>
          </select>
        </div>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span id="connectionStatus">å·²è¿æ¥</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
              <div>æ¬¢è¿ä½¿ç”¨ AI å¼€å‘åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ ï¼š</div>
              <div style="margin-top: 8px;">
                â€¢ ç”Ÿæˆå’Œä¿®æ”¹ä»£ç <br>
                â€¢ è¿›è¡Œä»£ç å®¡æŸ¥å’Œåˆ†æ<br>
                â€¢ ç®¡ç†é¡¹ç›®ä¾èµ–å’Œæ„å»º<br>
                â€¢ æ‰§è¡Œ Git æ“ä½œ<br>
                â€¢ ä¸€é”®éƒ¨ç½²åˆ° Netlify
              </div>
              <div class="message-time" id="welcomeTime"></div>
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea id="messageInput" class="chat-input" placeholder="æè¿°ä½ çš„å¼€å‘éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šä¸º dev é¡¹ç›®æ·»åŠ ä¸€ä¸ªç”¨æˆ·ç™»å½•ç»„ä»¶..."
              rows="1"></textarea>
            <div class="chat-buttons">
              <button id="sendBtn" class="btn btn-primary">
                <span id="sendBtnText">å‘é€</span>
                <span id="sendBtnIcon">ğŸ“¤</span>
              </button>
              <button id="clearBtn" class="btn btn-secondary">æ¸…ç©º</button>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">é¡¹ç›®ä¿¡æ¯</div>
        </div>
        <div class="sidebar-content">
          <div class="project-info" id="projectInfo">
            <h3>å½“å‰é¡¹ç›®</h3>
            <p>è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®å¼€å§‹å¼€å‘</p>
          </div>

          <div class="quick-actions">
            <h3>å¿«é€Ÿæ“ä½œ</h3>
            <button class="quick-action-btn" onclick="quickAction('install')">
              ğŸ“¦ å®‰è£…ä¾èµ–
            </button>
            <button class="quick-action-btn" onclick="quickAction('build')">
              ğŸ”¨ æ„å»ºé¡¹ç›®
            </button>
            <button class="quick-action-btn" onclick="quickAction('test')">
              ğŸ§ª è¿è¡Œæµ‹è¯•
            </button>
            <button class="quick-action-btn" onclick="quickAction('git-status')">
              ğŸ“Š Git çŠ¶æ€
            </button>
            <button class="quick-action-btn" onclick="quickAction('deploy')">
              ğŸš€ éƒ¨ç½²é¡¹ç›®
            </button>
          </div>

          <div class="quick-actions" style="margin-top: 16px;">
            <h3>ç³»ç»Ÿç›‘æ§</h3>
            <button class="quick-action-btn" onclick="showSystemStats()">
              ğŸ“Š ç³»ç»Ÿç»Ÿè®¡
            </button>
            <button class="quick-action-btn" onclick="showProjectStats()">
              ğŸ“ˆ é¡¹ç›®ç»Ÿè®¡
            </button>
            <button class="quick-action-btn" onclick="showServiceHealth()">
              â¤ï¸ æœåŠ¡å¥åº·
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let currentProject = '';
    let isStreaming = false;
    let eventSource = null;

    // API åŸºç¡€ URL
    const API_BASE = window.location.origin;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
      setupEventListeners();
      loadProjects();
      updateWelcomeTime();
    });

    // åˆå§‹åŒ–åº”ç”¨
    function initializeApp() {
      // è®¾ç½®è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // å›è½¦å‘é€æ¶ˆæ¯
      messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('clearBtn').addEventListener('click', clearMessages);
      document.getElementById('projectSelect').addEventListener('change', onProjectChange);
    }

    // åŠ è½½é¡¹ç›®åˆ—è¡¨
    async function loadProjects() {
      try {
        const response = await fetch(`${API_BASE}/api/projects`);
        const data = await response.json();

        if (data.success) {
          const projectSelect = document.getElementById('projectSelect');
          projectSelect.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®...</option>';

          data.projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            projectSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
        showError('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥');
      }
    }

    // é¡¹ç›®é€‰æ‹©å˜åŒ–
    async function onProjectChange(event) {
      const project = event.target.value;
      currentProject = project;

      if (project) {
        await loadProjectInfo(project);
        updateProjectInfo(project);
      } else {
        updateProjectInfo('');
      }
    }

    // åŠ è½½é¡¹ç›®ä¿¡æ¯
    async function loadProjectInfo(project) {
      try {
        const response = await fetch(`${API_BASE}/api/projects/${project}`);
        const data = await response.json();

        if (data.success) {
          updateProjectInfo(project, data.project);
        }
      } catch (error) {
        console.error('åŠ è½½é¡¹ç›®ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // æ›´æ–°é¡¹ç›®ä¿¡æ¯æ˜¾ç¤º
    function updateProjectInfo(project, info = null) {
      const projectInfo = document.getElementById('projectInfo');

      if (project && info) {
        projectInfo.innerHTML = `
          <h3>${project}</h3>
          <p><strong>è·¯å¾„:</strong> ${info.path}</p>
          <p><strong>çŠ¶æ€:</strong> <span class="project-status ${info.exists ? 'status-active' : 'status-inactive'}">${info.exists ? 'æ´»è·ƒ' : 'æœªæ‰¾åˆ°'}</span></p>
          <p><strong>Package.json:</strong> ${info.hasPackageJson ? 'âœ…' : 'âŒ'}</p>
          <p><strong>Node Modules:</strong> ${info.hasNodeModules ? 'âœ…' : 'âŒ'}</p>
        `;
      } else if (project) {
        projectInfo.innerHTML = `
          <h3>${project}</h3>
          <p>æ­£åœ¨åŠ è½½é¡¹ç›®ä¿¡æ¯...</p>
        `;
      } else {
        projectInfo.innerHTML = `
          <h3>å½“å‰é¡¹ç›®</h3>
          <p>è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®å¼€å§‹å¼€å‘</p>
        `;
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();

      if (!message) return;

      if (!currentProject) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®');
        return;
      }

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessage('user', message);
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // è®¾ç½®å‘é€æŒ‰é’®çŠ¶æ€
      setSendButtonState(true);

      try {
        // å‘é€è¯·æ±‚åˆ°åç«¯
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            project: currentProject,
            prompt: message
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // å¤„ç†æµå¼å“åº”
        await handleStreamingResponse(response);

      } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        showError('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message);
        setSendButtonState(false);
      }
    }

    // å¤„ç†æµå¼å“åº”
    async function handleStreamingResponse(response) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨
      const streamingContainer = createStreamingMessage();

      try {
        while (true) {
          const { done, value } = await reader.read();

          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                updateStreamingMessage(streamingContainer, data);
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        }
      } finally {
        reader.releaseLock();
        setSendButtonState(false);
      }
    }

    // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨
    function createStreamingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      messageDiv.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
          <div class="streaming-message" id="streamingContent"></div>
          <div class="message-time" id="streamingTime"></div>
        </div>
      `;

      document.getElementById('chatMessages').appendChild(messageDiv);
      scrollToBottom();

      return messageDiv;
    }

    // æ›´æ–°æµå¼æ¶ˆæ¯
    function updateStreamingMessage(container, data) {
      const content = container.querySelector('#streamingContent');
      const time = container.querySelector('#streamingTime');

      if (data.type === 'start') {
        content.innerHTML = '<div class="log-line log-info">ğŸš€ ' + data.message + '</div>';
        time.textContent = new Date().toLocaleTimeString();
      } else if (data.type === 'data') {
        const logLine = document.createElement('div');
        logLine.className = 'log-line';

        if (data.message.includes('[ERROR]')) {
          logLine.className += ' log-error';
        } else if (data.message.includes('[WARNING]')) {
          logLine.className += ' log-warning';
        } else {
          logLine.className += ' log-info';
        }

        logLine.textContent = data.message;
        content.appendChild(logLine);
        scrollToBottom();
      } else if (data.type === 'complete') {
        content.innerHTML += '<div class="log-line log-info">âœ… ' + data.message + '</div>';
        time.textContent = new Date().toLocaleTimeString();
      } else if (data.type === 'error') {
        content.innerHTML += '<div class="log-line log-error">âŒ ' + data.message + '</div>';
        time.textContent = new Date().toLocaleTimeString();
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function addMessage(type, content) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const avatar = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
      const time = new Date().toLocaleTimeString();

      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          <div>${content}</div>
          <div class="message-time">${time}</div>
        </div>
      `;

      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // å¿«é€Ÿæ“ä½œ
    async function quickAction(action) {
      if (!currentProject) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®');
        return;
      }

      const actions = {
        'install': () => executeCommand('install', 'å®‰è£…é¡¹ç›®ä¾èµ–'),
        'build': () => executeCommand('build', 'æ„å»ºé¡¹ç›®'),
        'test': () => executeCommand('test', 'è¿è¡Œæµ‹è¯•'),
        'git-status': () => showGitStatus(),
        'deploy': () => deployProject()
      };

      if (actions[action]) {
        await actions[action]();
      }
    }

    // æ‰§è¡Œå‘½ä»¤
    async function executeCommand(command, description) {
      addMessage('assistant', `æ­£åœ¨${description}...`);

      try {
        const response = await fetch(`${API_BASE}/api/stream/command`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            project: currentProject,
            command: command,
            type: command
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        await handleStreamingResponse(response);
      } catch (error) {
        console.error('æ‰§è¡Œå‘½ä»¤å¤±è´¥:', error);
        showError('æ‰§è¡Œå‘½ä»¤å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤º Git çŠ¶æ€
    async function showGitStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/git/${currentProject}/branches`);
        const data = await response.json();

        if (data.success) {
          addMessage('assistant', `å½“å‰åˆ†æ”¯: ${data.branches.join(', ')}`);
        }
      } catch (error) {
        console.error('è·å– Git çŠ¶æ€å¤±è´¥:', error);
        showError('è·å– Git çŠ¶æ€å¤±è´¥');
      }
    }

    // éƒ¨ç½²é¡¹ç›®
    async function deployProject() {
      addMessage('assistant', 'æ­£åœ¨éƒ¨ç½²é¡¹ç›®åˆ° Netlify...');

      try {
        const response = await fetch(`${API_BASE}/api/deploy`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            project: currentProject
          })
        });

        const data = await response.json();

        if (data.success) {
          addMessage('assistant', `éƒ¨ç½²æˆåŠŸï¼è®¿é—®åœ°å€: ${data.url}`);
        } else {
          showError('éƒ¨ç½²å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        console.error('éƒ¨ç½²å¤±è´¥:', error);
        showError('éƒ¨ç½²å¤±è´¥: ' + error.message);
      }
    }

    // è®¾ç½®å‘é€æŒ‰é’®çŠ¶æ€
    function setSendButtonState(loading) {
      const sendBtn = document.getElementById('sendBtn');
      const sendBtnText = document.getElementById('sendBtnText');
      const sendBtnIcon = document.getElementById('sendBtnIcon');

      if (loading) {
        sendBtn.disabled = true;
        sendBtnText.textContent = 'å¤„ç†ä¸­';
        sendBtnIcon.innerHTML = '<div class="loading"></div>';
      } else {
        sendBtn.disabled = false;
        sendBtnText.textContent = 'å‘é€';
        sendBtnIcon.textContent = 'ğŸ“¤';
      }
    }

    // æ¸…ç©ºæ¶ˆæ¯
    function clearMessages() {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = `
        <div class="message assistant">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content">
            <div>æ¬¢è¿ä½¿ç”¨ AI å¼€å‘åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ ï¼š</div>
            <div style="margin-top: 8px;">
              â€¢ ç”Ÿæˆå’Œä¿®æ”¹ä»£ç <br>
              â€¢ è¿›è¡Œä»£ç å®¡æŸ¥å’Œåˆ†æ<br>
              â€¢ ç®¡ç†é¡¹ç›®ä¾èµ–å’Œæ„å»º<br>
              â€¢ æ‰§è¡Œ Git æ“ä½œ<br>
              â€¢ ä¸€é”®éƒ¨ç½²åˆ° Netlify
            </div>
            <div class="message-time" id="welcomeTime"></div>
          </div>
        </div>
      `;
      updateWelcomeTime();
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showError(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      messagesContainer.appendChild(errorDiv);
      scrollToBottom();
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      messagesContainer.appendChild(successDiv);
      scrollToBottom();
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // æ›´æ–°æ¬¢è¿æ—¶é—´
    function updateWelcomeTime() {
      const welcomeTime = document.getElementById('welcomeTime');
      if (welcomeTime) {
        welcomeTime.textContent = new Date().toLocaleTimeString();
      }
    }

    // æ£€æŸ¥è¿æ¥çŠ¶æ€
    function checkConnection() {
      fetch(`${API_BASE}/health`)
        .then(response => response.json())
        .then(data => {
          const statusElement = document.getElementById('connectionStatus');
          const dotElement = document.querySelector('.status-dot');

          if (data.status === 'ok') {
            statusElement.textContent = 'å·²è¿æ¥';
            dotElement.style.background = '#4ade80';
          } else {
            statusElement.textContent = 'è¿æ¥å¼‚å¸¸';
            dotElement.style.background = '#ef4444';
          }
        })
        .catch(error => {
          const statusElement = document.getElementById('connectionStatus');
          const dotElement = document.querySelector('.status-dot');
          statusElement.textContent = 'è¿æ¥å¤±è´¥';
          dotElement.style.background = '#ef4444';
        });
    }

    // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
    setInterval(checkConnection, 30000);
    checkConnection();

    // ç›‘æ§é¢æ¿åŠŸèƒ½
    async function showSystemStats() {
      try {
        const response = await fetch(`${API_BASE}/api/monitor/stats`);
        const data = await response.json();

        if (data.success) {
          const stats = data.stats;
          let message = 'ğŸ“Š ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯:\n\n';
          message += `â±ï¸ è¿è¡Œæ—¶é—´: ${stats.uptime}\n`;
          message += `ğŸ’¾ å†…å­˜ä½¿ç”¨: ${stats.memory_usage.alloc_mb}MB (æ€»åˆ†é…: ${stats.memory_usage.total_alloc_mb}MB)\n`;
          message += `ğŸ’½ ç£ç›˜ä½¿ç”¨: ${stats.disk_usage.workspace_size_mb}MB\n`;
          message += `ğŸ–¥ï¸ CPUæ ¸å¿ƒ: ${stats.cpu_usage.num_cpu} (Goroutines: ${stats.cpu_usage.num_goroutines})\n`;
          message += `ğŸ“ é¡¹ç›®æ€»æ•°: ${stats.project_stats.total_projects} (æ´»è·ƒ: ${stats.project_stats.active_projects})\n`;
          message += `ğŸ”§ æœåŠ¡çŠ¶æ€: ${JSON.stringify(stats.service_status, null, 2)}\n`;

          addMessage('assistant', message);
        } else {
          showError('è·å–ç³»ç»Ÿç»Ÿè®¡å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–ç³»ç»Ÿç»Ÿè®¡å¤±è´¥:', error);
        showError('è·å–ç³»ç»Ÿç»Ÿè®¡å¤±è´¥: ' + error.message);
      }
    }

    async function showProjectStats() {
      try {
        const response = await fetch(`${API_BASE}/api/monitor/projects`);
        const data = await response.json();

        if (data.success) {
          const stats = data.project_stats;
          let message = 'ğŸ“ˆ é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯:\n\n';
          message += `ğŸ“Š æ€»é¡¹ç›®æ•°: ${stats.total_projects}\n`;
          message += `âœ… æ´»è·ƒé¡¹ç›®: ${stats.active_projects}\n`;
          message += `ğŸ“ æ€»æäº¤æ•°: ${stats.total_commits}\n`;
          message += `ğŸš€ æ€»éƒ¨ç½²æ•°: ${stats.total_deployments}\n\n`;

          message += 'ğŸ“‹ é¡¹ç›®è¯¦æƒ…:\n';
          stats.project_details.forEach(project => {
            message += `â€¢ ${project.name}: ${project.exists ? 'âœ…' : 'âŒ'} `;
            if (project.git_stats) {
              message += `(æäº¤: ${project.git_stats.commit_count}, åˆ†æ”¯: ${project.git_stats.branch})\n`;
            } else {
              message += '\n';
            }
          });

          addMessage('assistant', message);
        } else {
          showError('è·å–é¡¹ç›®ç»Ÿè®¡å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–é¡¹ç›®ç»Ÿè®¡å¤±è´¥:', error);
        showError('è·å–é¡¹ç›®ç»Ÿè®¡å¤±è´¥: ' + error.message);
      }
    }

    async function showServiceHealth() {
      try {
        const response = await fetch(`${API_BASE}/api/monitor/health`);
        const data = await response.json();

        if (data.success) {
          const health = data.health;
          let message = 'â¤ï¸ æœåŠ¡å¥åº·çŠ¶æ€:\n\n';
          message += `ğŸ¯ æ•´ä½“çŠ¶æ€: ${health.overall}\n\n`;

          message += 'ğŸ”§ æœåŠ¡è¯¦æƒ…:\n';
          Object.entries(health.services).forEach(([service, info]) => {
            const status = info.status;
            const emoji = status === 'healthy' ? 'âœ…' : 'âŒ';
            message += `${emoji} ${service}: ${status}`;
            if (info.response_time) {
              message += ` (å“åº”æ—¶é—´: ${info.response_time})`;
            }
            if (info.available !== undefined) {
              message += ` (å¯ç”¨: ${info.available ? 'æ˜¯' : 'å¦'})`;
            }
            message += '\n';
          });

          addMessage('assistant', message);
        } else {
          showError('è·å–æœåŠ¡å¥åº·çŠ¶æ€å¤±è´¥');
        }
      } catch (error) {
        console.error('è·å–æœåŠ¡å¥åº·çŠ¶æ€å¤±è´¥:', error);
        showError('è·å–æœåŠ¡å¥åº·çŠ¶æ€å¤±è´¥: ' + error.message);
      }
    }
  </script>
</body>

</html>
