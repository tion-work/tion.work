<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tion èŠå¤©åŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .chat-container {
      width: 100vw;
      height: 100vh;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .chat-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .chat-header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8f9fa;
      width: 100%;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-start;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 60%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: white;
      color: #333;
      border: 1px solid #e9ecef;
      border-bottom-left-radius: 4px;
    }

    .message.assistant .message-content pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 10px;
      font-size: 12px;
    }

    .chat-input {
      padding: 20px;
      background: white;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 15px;
      width: 100%;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
      font-size: 14px;
    }

    .chat-input input:focus {
      border-color: #667eea;
    }

    .chat-input button {
      margin: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      color: #333;
      transition: all 0.2s;
    }

    .chat-input button:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }

    .chat-input button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .command-menu {
      position: relative;
      display: inline-block;
    }

    .menu-button {
      margin: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      color: #333;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .menu-button:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }

    .menu-dropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      min-width: 320px;
      max-height: 450px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      margin-bottom: 10px;
    }

    .menu-dropdown.show {
      display: block;
    }

    .menu-section {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      background: none;
      margin-bottom: 8px;
      border-radius: 0;
    }

    .menu-section:last-child {
      border-bottom: none;
    }

    .menu-section-title {
      font-size: 13px;
      font-weight: 700;
      color: #444;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 6px;
    }

    .menu-item {
      display: block;
      width: 100%;
      margin: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      text-align: left;
      cursor: pointer;
      font-size: 12px;
      color: #333;
      border-radius: 15px;
      transition: all 0.2s;
      margin-bottom: 3px;
    }

    .menu-item:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }

    .menu-item:last-child {
      margin-bottom: 0;
    }

    .menu-item-description {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
      font-weight: 400;
      line-height: 1.3;
    }

    /* Markdown æ ·å¼ */
    .message-content h1,
    .message-content h2,
    .message-content h3 {
      margin: 10px 0 5px 0;
      font-weight: 600;
    }

    .message-content h1 {
      font-size: 18px;
      color: #333;
    }

    .message-content h2 {
      font-size: 16px;
      color: #444;
    }

    .message-content h3 {
      font-size: 14px;
      color: #555;
    }

    .message-content pre {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .message-content code {
      background: #f1f3f4;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
    }

    .message-content ul,
    .message-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message-content li {
      margin: 4px 0;
    }

    .message-content a {
      color: #667eea;
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-content strong {
      font-weight: 600;
    }

    .message-content em {
      font-style: italic;
    }

    .loading {
      display: none;
      align-items: center;
      gap: 10px;
      color: #666;
      font-size: 14px;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .status {
      padding: 10px 20px;
      background: #e8f5e8;
      color: #2d5a2d;
      font-size: 12px;
      text-align: center;
    }

    .status.error {
      background: #ffeaea;
      color: #d32f2f;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>ğŸ¤– Tion èŠå¤©åŠ©æ‰‹</h1>
      <p>é€šè¿‡ AI åŠ©æ‰‹ç®¡ç†ä½ çš„é¡¹ç›®</p>
    </div>

    <div class="status" id="status">
      è¿æ¥ä¸­...
    </div>

    <div class="chat-messages" id="messages">
      <div class="message assistant">
        <div class="message-content">
          ä½ å¥½ï¼æˆ‘æ˜¯ Tion èŠå¤©åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ ï¼š
          <br>â€¢ åˆ†æå’Œä¿®æ”¹ä»£ç 
          <br>â€¢ æ‰§è¡Œæµ‹è¯•å’Œè¯„å®¡
          <br>â€¢ ç®¡ç†é¡¹ç›®å‘å¸ƒ
          <br>â€¢ å›ç­”æŠ€æœ¯é—®é¢˜
          <br><br>è¯·å‘Šè¯‰æˆ‘ä½ æƒ³è¦åšä»€ä¹ˆï¼Ÿ
        </div>
      </div>
    </div>

    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="è¾“å…¥ä½ çš„å‘½ä»¤æˆ–é—®é¢˜..." />
      <div class="command-menu">
        <button class="menu-button" id="menuButton">
          ğŸ“‹ å‘½ä»¤
        </button>
        <div class="menu-dropdown" id="menuDropdown">
          <div class="menu-section">
            <div class="menu-section-title">ğŸš€ å¼€å‘å‘½ä»¤</div>
            <button class="menu-item" data-command="make install">
              <div>install</div>
              <div class="menu-item-description">å®‰è£…æ‰€æœ‰ä¾èµ–</div>
            </button>
            <button class="menu-item" data-command="make start">
              <div>start</div>
              <div class="menu-item-description">å¯åŠ¨æ‰€æœ‰å‰ç«¯ + åç«¯</div>
            </button>
            <button class="menu-item" data-command="make dev">
              <div>dev</div>
              <div class="menu-item-description">ä»…å¯åŠ¨å¼€å‘å·¥å…·ç«™ (ç«¯å£ 3002)</div>
            </button>
            <button class="menu-item" data-command="make index">
              <div>index</div>
              <div class="menu-item-description">ä»…å¯åŠ¨ä¸»ç«™ (ç«¯å£ 3001)</div>
            </button>
            <button class="menu-item" data-command="make admin">
              <div>admin</div>
              <div class="menu-item-description">ä»…å¯åŠ¨ç®¡ç†åå° (ç«¯å£ 3003)</div>
            </button>
            <button class="menu-item" data-command="make backend">
              <div>backend</div>
              <div class="menu-item-description">ä»…å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨ (ç«¯å£ 8080)</div>
            </button>
            <button class="menu-item" data-command="make stop">
              <div>stop</div>
              <div class="menu-item-description">åœæ­¢æ‰€æœ‰æœåŠ¡</div>
            </button>
            <button class="menu-item" data-command="make restart">
              <div>restart</div>
              <div class="menu-item-description">é‡å¯å¼€å‘ç¯å¢ƒ</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">ğŸ”¨ æ„å»ºå‘½ä»¤</div>
            <button class="menu-item" data-command="make build">
              <div>build</div>
              <div class="menu-item-description">æ„å»ºæ‰€æœ‰é¡¹ç›®</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">ğŸ§ª æµ‹è¯•å’Œæ£€æŸ¥</div>
            <button class="menu-item" data-command="make test">
              <div>test</div>
              <div class="menu-item-description">è¿è¡Œæ‰€æœ‰æµ‹è¯•</div>
            </button>
            <button class="menu-item" data-command="make check">
              <div>check</div>
              <div class="menu-item-description">ä»£ç è´¨é‡æ£€æŸ¥</div>
            </button>
            <button class="menu-item" data-command="make lint">
              <div>lint</div>
              <div class="menu-item-description">è¿è¡Œä»£ç æ£€æŸ¥</div>
            </button>
            <button class="menu-item" data-command="make lint-fix">
              <div>lint-fix</div>
              <div class="menu-item-description">è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">ğŸ§¹ æ¸…ç†å‘½ä»¤</div>
            <button class="menu-item" data-command="make clean">
              <div>clean</div>
              <div class="menu-item-description">æ¸…ç†æ„å»ºæ–‡ä»¶å’Œä¾èµ–</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">ğŸš€ ç”Ÿäº§éƒ¨ç½²</div>
            <button class="menu-item" data-command="make deploy-api">
              <div>deploy-api</div>
              <div class="menu-item-description">éƒ¨ç½²åç«¯APIåˆ°Railway</div>
            </button>
            <button class="menu-item" data-command="make deploy-dev">
              <div>deploy-dev</div>
              <div class="menu-item-description">éƒ¨ç½²å¼€å‘å·¥å…·ç«™åˆ°Netlify</div>
            </button>
            <button class="menu-item" data-command="make deploy-all">
              <div>deploy-all</div>
              <div class="menu-item-description">éƒ¨ç½²æ‰€æœ‰é¡¹ç›®åˆ°ç”Ÿäº§ç¯å¢ƒ</div>
            </button>
          </div>
        </div>
      </div>
      <button id="sendButton">å‘é€</button>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const status = document.getElementById('status');
    const menuButton = document.getElementById('menuButton');
    const menuDropdown = document.getElementById('menuDropdown');

    // æ£€æŸ¥æœåŠ¡çŠ¶æ€
    async function checkStatus() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          status.textContent = 'âœ… æœåŠ¡å·²è¿æ¥';
          status.className = 'status';
        } else {
          throw new Error('æœåŠ¡ä¸å¯ç”¨');
        }
      } catch (error) {
        status.textContent = 'âŒ æœåŠ¡è¿æ¥å¤±è´¥';
        status.className = 'status error';
      }
    }

    // Markdown æ ¼å¼åŒ–å‡½æ•°
    function formatMarkdown(text) {
      if (!text) return '';

      let formatted = text;

      // ä»£ç å— (```language\ncode\n```)
      formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');

      // è¡Œå†…ä»£ç  (`code`)
      formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

      // ç²—ä½“ (**text** æˆ– __text__)
      formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>');

      // æ–œä½“ (*text* æˆ– _text_)
      formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
      formatted = formatted.replace(/_(.*?)_/g, '<em>$1</em>');

      // æ ‡é¢˜ (# ## ###)
      formatted = formatted.replace(/^### (.*$)/gm, '<h3>$1</h3>');
      formatted = formatted.replace(/^## (.*$)/gm, '<h2>$1</h2>');
      formatted = formatted.replace(/^# (.*$)/gm, '<h1>$1</h1>');

      // åˆ—è¡¨ (- item æˆ– * item)
      formatted = formatted.replace(/^[\-\*] (.*$)/gm, '<li>$1</li>');
      formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

      // æ•°å­—åˆ—è¡¨ (1. item)
      formatted = formatted.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
      formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');

      // é“¾æ¥ [text](url)
      formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

      // æ¢è¡Œ
      formatted = formatted.replace(/\n/g, '<br>');

      return formatted;
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      if (typeof content === 'string') {
        contentDiv.innerHTML = isUser ? content.replace(/\n/g, '<br>') : formatMarkdown(content);
      } else {
        contentDiv.innerHTML = content;
      }

      messageDiv.appendChild(contentDiv);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(message, true);
      messageInput.value = '';

      // åˆ›å»ºæµå¼å“åº”å®¹å™¨
      const streamDiv = document.createElement('div');
      streamDiv.className = 'message assistant';
      streamDiv.innerHTML = '<div class="message-content" id="streamContent">ğŸ¤– AI åŠ©æ‰‹æ­£åœ¨å¤„ç†å‘½ä»¤...<br><br></div>';
      messagesContainer.appendChild(streamDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      const streamContent = document.getElementById('streamContent');
      let fullContent = '';

      sendButton.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (data.type === 'start') {
                  streamContent.innerHTML = `ğŸš€ ${data.message}<br><br>`;
                } else if (data.type === 'chunk') {
                  fullContent += data.content;
                  // æ ¼å¼åŒ– Markdown å†…å®¹
                  let formattedContent = formatMarkdown(fullContent);
                  streamContent.innerHTML = `ğŸš€ å¼€å§‹æ‰§è¡Œå‘½ä»¤...<br><br>${formattedContent}`;
                  messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else if (data.type === 'complete') {
                  streamContent.innerHTML = `âœ… å‘½ä»¤æ‰§è¡Œå®Œæˆï¼<br><br>${formatMarkdown(fullContent)}`;
                } else if (data.type === 'error') {
                  streamContent.innerHTML = `âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${data.message}`;
                }
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        }
      } catch (error) {
        streamContent.innerHTML = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
      } finally {
        sendButton.disabled = false;
      }
    }

    // èœå•åŠŸèƒ½
    function toggleMenu() {
      menuDropdown.classList.toggle('show');
    }

    function closeMenu() {
      menuDropdown.classList.remove('show');
    }

    function selectCommand(command) {
      // æ·»åŠ æç¤ºä¿¡æ¯
      const commandName = command.replace('make ', '');
      addMessage(`ğŸ’¡ å·²é€‰æ‹©å‘½ä»¤: <strong>${command}</strong><br>æ­£åœ¨æ‰§è¡Œ...`, false);

      messageInput.value = command;
      closeMenu();
      sendMessage();
    }

    // äº‹ä»¶ç›‘å¬
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // èœå•äº‹ä»¶
    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    // ç‚¹å‡»èœå•é¡¹
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const command = item.getAttribute('data-command');
        selectCommand(command);
      });
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
    document.addEventListener('click', (e) => {
      if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) {
        closeMenu();
      }
    });

    // åˆå§‹åŒ–
    checkStatus();

    // ç¤ºä¾‹å‘½ä»¤æŒ‰é’®
    const exampleCommands = [
      'åˆ†æé¡¹ç›®ç»“æ„',
      'ä¿®æ”¹é¦–é¡µæ ‡é¢˜',
      'è¿è¡Œæµ‹è¯•',
      'æ£€æŸ¥ä»£ç è´¨é‡'
    ];

    // æ·»åŠ ç¤ºä¾‹å‘½ä»¤
    setTimeout(() => {
      const exampleDiv = document.createElement('div');
      exampleDiv.innerHTML = '<br><strong>ğŸ’¡ è¯•è¯•è¿™äº›å‘½ä»¤ï¼š</strong><br>' +
        exampleCommands.map(cmd => `<button onclick="messageInput.value='${cmd}'; sendMessage();" style="margin: 5px; padding: 5px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 15px; cursor: pointer; font-size: 12px;">${cmd}</button>`).join(' ');
      addMessage(exampleDiv.innerHTML);
    }, 1000);
  </script>
</body>

</html>
