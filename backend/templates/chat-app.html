<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tion 聊天助手</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .chat-container {
      width: 100vw;
      height: 100vh;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .chat-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .chat-header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8f9fa;
      width: 100%;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-start;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 60%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: white;
      color: #333;
      border: 1px solid #e9ecef;
      border-bottom-left-radius: 4px;
    }

    .message.assistant .message-content pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 10px;
      font-size: 12px;
    }

    .chat-input {
      padding: 20px;
      background: white;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 15px;
      width: 100%;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
      font-size: 14px;
    }

    .chat-input input:focus {
      border-color: #667eea;
    }

    .chat-input button {
      margin: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      color: #333;
      transition: all 0.2s;
    }

    .chat-input button:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }

    .chat-input button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .command-menu {
      position: relative;
      display: inline-block;
    }

    .menu-button {
      margin: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      color: #333;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .menu-button:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }

    .menu-dropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      min-width: 320px;
      max-height: 450px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      margin-bottom: 10px;
    }

    .menu-dropdown.show {
      display: block;
    }

    .menu-section {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      background: none;
      margin-bottom: 8px;
      border-radius: 0;
    }

    .menu-section:last-child {
      border-bottom: none;
    }

    .menu-section-title {
      font-size: 13px;
      font-weight: 700;
      color: #444;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 6px;
    }

    .menu-item {
      display: block;
      width: 100%;
      margin: 5px;
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      text-align: left;
      cursor: pointer;
      font-size: 12px;
      color: #333;
      border-radius: 15px;
      transition: all 0.2s;
      margin-bottom: 3px;
    }

    .menu-item:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }

    .menu-item:last-child {
      margin-bottom: 0;
    }

    .menu-item-description {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
      font-weight: 400;
      line-height: 1.3;
    }

    /* Markdown 样式 */
    .message-content h1,
    .message-content h2,
    .message-content h3 {
      margin: 10px 0 5px 0;
      font-weight: 600;
    }

    .message-content h1 {
      font-size: 18px;
      color: #333;
    }

    .message-content h2 {
      font-size: 16px;
      color: #444;
    }

    .message-content h3 {
      font-size: 14px;
      color: #555;
    }

    .message-content pre {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .message-content code {
      background: #f1f3f4;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
    }

    .message-content ul,
    .message-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message-content li {
      margin: 4px 0;
    }

    .message-content a {
      color: #667eea;
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-content strong {
      font-weight: 600;
    }

    .message-content em {
      font-style: italic;
    }

    .loading {
      display: none;
      align-items: center;
      gap: 10px;
      color: #666;
      font-size: 14px;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .status {
      padding: 10px 20px;
      background: #e8f5e8;
      color: #2d5a2d;
      font-size: 12px;
      text-align: center;
    }

    .status.error {
      background: #ffeaea;
      color: #d32f2f;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>🤖 Tion 聊天助手</h1>
      <p>通过 AI 助手管理你的项目</p>
    </div>

    <div class="status" id="status">
      连接中...
    </div>

    <div class="chat-messages" id="messages">
      <div class="message assistant">
        <div class="message-content">
          你好！我是 Tion 聊天助手。我可以帮你：
          <br>• 分析和修改代码
          <br>• 执行测试和评审
          <br>• 管理项目发布
          <br>• 回答技术问题
          <br><br>请告诉我你想要做什么？
        </div>
      </div>
    </div>

    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="输入你的命令或问题..." />
      <div class="command-menu">
        <button class="menu-button" id="menuButton">
          📋 命令
        </button>
        <div class="menu-dropdown" id="menuDropdown">
          <div class="menu-section">
            <div class="menu-section-title">🚀 开发命令</div>
            <button class="menu-item" data-command="make install">
              <div>install</div>
              <div class="menu-item-description">安装所有依赖</div>
            </button>
            <button class="menu-item" data-command="make start">
              <div>start</div>
              <div class="menu-item-description">启动所有前端 + 后端</div>
            </button>
            <button class="menu-item" data-command="make dev">
              <div>dev</div>
              <div class="menu-item-description">仅启动开发工具站 (端口 3002)</div>
            </button>
            <button class="menu-item" data-command="make index">
              <div>index</div>
              <div class="menu-item-description">仅启动主站 (端口 3001)</div>
            </button>
            <button class="menu-item" data-command="make admin">
              <div>admin</div>
              <div class="menu-item-description">仅启动管理后台 (端口 3003)</div>
            </button>
            <button class="menu-item" data-command="make backend">
              <div>backend</div>
              <div class="menu-item-description">仅启动后端开发服务器 (端口 8080)</div>
            </button>
            <button class="menu-item" data-command="make stop">
              <div>stop</div>
              <div class="menu-item-description">停止所有服务</div>
            </button>
            <button class="menu-item" data-command="make restart">
              <div>restart</div>
              <div class="menu-item-description">重启开发环境</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">🔨 构建命令</div>
            <button class="menu-item" data-command="make build">
              <div>build</div>
              <div class="menu-item-description">构建所有项目</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">🧪 测试和检查</div>
            <button class="menu-item" data-command="make test">
              <div>test</div>
              <div class="menu-item-description">运行所有测试</div>
            </button>
            <button class="menu-item" data-command="make check">
              <div>check</div>
              <div class="menu-item-description">代码质量检查</div>
            </button>
            <button class="menu-item" data-command="make lint">
              <div>lint</div>
              <div class="menu-item-description">运行代码检查</div>
            </button>
            <button class="menu-item" data-command="make lint-fix">
              <div>lint-fix</div>
              <div class="menu-item-description">自动修复代码问题</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">🧹 清理命令</div>
            <button class="menu-item" data-command="make clean">
              <div>clean</div>
              <div class="menu-item-description">清理构建文件和依赖</div>
            </button>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">🚀 生产部署</div>
            <button class="menu-item" data-command="make deploy-api">
              <div>deploy-api</div>
              <div class="menu-item-description">部署后端API到Railway</div>
            </button>
            <button class="menu-item" data-command="make deploy-dev">
              <div>deploy-dev</div>
              <div class="menu-item-description">部署开发工具站到Netlify</div>
            </button>
            <button class="menu-item" data-command="make deploy-all">
              <div>deploy-all</div>
              <div class="menu-item-description">部署所有项目到生产环境</div>
            </button>
          </div>
        </div>
      </div>
      <button id="sendButton">发送</button>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const status = document.getElementById('status');
    const menuButton = document.getElementById('menuButton');
    const menuDropdown = document.getElementById('menuDropdown');

    // 检查服务状态
    async function checkStatus() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          status.textContent = '✅ 服务已连接';
          status.className = 'status';
        } else {
          throw new Error('服务不可用');
        }
      } catch (error) {
        status.textContent = '❌ 服务连接失败';
        status.className = 'status error';
      }
    }

    // Markdown 格式化函数
    function formatMarkdown(text) {
      if (!text) return '';

      let formatted = text;

      // 代码块 (```language\ncode\n```)
      formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');

      // 行内代码 (`code`)
      formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

      // 粗体 (**text** 或 __text__)
      formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>');

      // 斜体 (*text* 或 _text_)
      formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
      formatted = formatted.replace(/_(.*?)_/g, '<em>$1</em>');

      // 标题 (# ## ###)
      formatted = formatted.replace(/^### (.*$)/gm, '<h3>$1</h3>');
      formatted = formatted.replace(/^## (.*$)/gm, '<h2>$1</h2>');
      formatted = formatted.replace(/^# (.*$)/gm, '<h1>$1</h1>');

      // 列表 (- item 或 * item)
      formatted = formatted.replace(/^[\-\*] (.*$)/gm, '<li>$1</li>');
      formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

      // 数字列表 (1. item)
      formatted = formatted.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
      formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');

      // 链接 [text](url)
      formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

      // 换行
      formatted = formatted.replace(/\n/g, '<br>');

      return formatted;
    }

    // 添加消息到聊天界面
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      if (typeof content === 'string') {
        contentDiv.innerHTML = isUser ? content.replace(/\n/g, '<br>') : formatMarkdown(content);
      } else {
        contentDiv.innerHTML = content;
      }

      messageDiv.appendChild(contentDiv);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 发送消息
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // 添加用户消息
      addMessage(message, true);
      messageInput.value = '';

      // 创建流式响应容器
      const streamDiv = document.createElement('div');
      streamDiv.className = 'message assistant';
      streamDiv.innerHTML = '<div class="message-content" id="streamContent">🤖 AI 助手正在处理命令...<br><br></div>';
      messagesContainer.appendChild(streamDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      const streamContent = document.getElementById('streamContent');
      let fullContent = '';

      sendButton.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (data.type === 'start') {
                  streamContent.innerHTML = `🚀 ${data.message}<br><br>`;
                } else if (data.type === 'chunk') {
                  fullContent += data.content;
                  // 格式化 Markdown 内容
                  let formattedContent = formatMarkdown(fullContent);
                  streamContent.innerHTML = `🚀 开始执行命令...<br><br>${formattedContent}`;
                  messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else if (data.type === 'complete') {
                  streamContent.innerHTML = `✅ 命令执行完成！<br><br>${formatMarkdown(fullContent)}`;
                } else if (data.type === 'error') {
                  streamContent.innerHTML = `❌ 命令执行失败: ${data.message}`;
                }
              } catch (e) {
                // 忽略解析错误
              }
            }
          }
        }
      } catch (error) {
        streamContent.innerHTML = `❌ 网络错误: ${error.message}`;
      } finally {
        sendButton.disabled = false;
      }
    }

    // 菜单功能
    function toggleMenu() {
      menuDropdown.classList.toggle('show');
    }

    function closeMenu() {
      menuDropdown.classList.remove('show');
    }

    function selectCommand(command) {
      // 添加提示信息
      const commandName = command.replace('make ', '');
      addMessage(`💡 已选择命令: <strong>${command}</strong><br>正在执行...`, false);

      messageInput.value = command;
      closeMenu();
      sendMessage();
    }

    // 事件监听
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // 菜单事件
    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    // 点击菜单项
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const command = item.getAttribute('data-command');
        selectCommand(command);
      });
    });

    // 点击外部关闭菜单
    document.addEventListener('click', (e) => {
      if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) {
        closeMenu();
      }
    });

    // 初始化
    checkStatus();

    // 示例命令按钮
    const exampleCommands = [
      '分析项目结构',
      '修改首页标题',
      '运行测试',
      '检查代码质量'
    ];

    // 添加示例命令
    setTimeout(() => {
      const exampleDiv = document.createElement('div');
      exampleDiv.innerHTML = '<br><strong>💡 试试这些命令：</strong><br>' +
        exampleCommands.map(cmd => `<button onclick="messageInput.value='${cmd}'; sendMessage();" style="margin: 5px; padding: 5px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 15px; cursor: pointer; font-size: 12px;">${cmd}</button>`).join(' ');
      addMessage(exampleDiv.innerHTML);
    }, 1000);
  </script>
</body>

</html>
